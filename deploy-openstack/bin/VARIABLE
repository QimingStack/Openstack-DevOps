#!/bin/bash 
#Edit the below variable to adapt your Env..

#------------------------Need to choose the network card  first -----------------------

function NET_NAME_IP(){
cat 1>&2 <<__EOF__
$MAGENTA=================================================================
     Network Cards on ${YELLOW}$(hostname)${NO_COLOR}${MAGENTA} list below: 
=================================================================
$NO_COLOR
__EOF__

NET_DEV_NAME=$(cat /proc/net/dev | awk '{print $1}' | sed -n '3,$p' | awk -F ":" '{print $1}' | grep -v ^lo$ | grep -v ^macvtap*)
#                                                                                              except the lo and        macvtap      network name 
for i in $NET_DEV_NAME
do
NET_RUN_STATUS=$(ifconfig $i | sed -n '1p' | awk '{print $2}' | awk -F "," '{print $3}')

if [[ $NET_RUN_STATUS != RUNNING ]];then
continue
else
echo ${BLUE}The network card Name:${NO_COLOR}$YELLOW $i${NO_COLOR} ${BLUE},the network card status:${NO_COLOR}
echo $GREEN $NET_RUN_STATUS $NO_COLOR
fi

echo ${BLUE}The IP address is : $NO_COLOR
IP_ADDR=$(ifconfig $i | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')
echo $GREEN $IP_ADDR $NO_COLOR

if [[ $IP_ADDR = "" ]];then
echo $RED No IP Address with $i $NO_COLOR
fi

done
}

#CONTROLLER_HOSTS=$(cat ./controller-hosts)
NET_NAME_IP
echo $MAGENTA Please choose a network card as Management network from above output on ${YELLOW}$(hostname)${NO_COLOR} 
read MGMT_IP_DEVICE
echo $GREEN You choose ${YELLOW}$MGMT_IP_DEVICE${COLOR}${GREEN} as Management network $NO_COLOR

#--------------------------------------- For controller only -----------------------------------------------------------------------------
#do 
#ntp server ad controller management ip
NTP_SERVER_IP=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')

#MGMT_IP is the controller management ip 
MGMT_IP=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')

#set mariadb password 
MARIADB_PASSWORD=admin

#set the rabbitmq host and password as below 
RABBIT_HOSTS=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')
RABBIT_PASS=rabbitmq

#--------------------Keystone ------------------
#set keystone database password 
KEYSTONE_DBPASS=keystone_dbpassword
ADMIN_PASS=admin
DEMO_PASS=demo
#Which directory you want to store the admin-openrc file ?
OPENRC_DIR=/home


#-----------------Glance-------------
#glance database password
GLANCE_DBPASS=glancedb
#glance password use for keystone
GLANCE_PASS=glance


#-----------------Nova for controller node --------
#both nova and nova_api database use this
NOVA_DBPASS=novadb
#nova pass for keystone 
NOVA_PASS=novapass
#nova.conf need my_ip 
#In the [DEFAULT] section, configure the my_ip option to use the management interface IP address of the controller node
#my_ip here:
MY_IP_CONTROLLER=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')

#--------------------Neutron for controller -----------
NEUTRON_DBPASS=neutrondb
NEUTRON_PASS=neutron

#--------------------Cinder for controller 
CINDERDB_PASS=cinderdb
CINDER_PASS=cinderpass

#---------------Controller HA proxy -----------
#This need to edit by  manual
CONTROLLER_VIP=10.245.58.205



#-------------------------------------nova compute node ------------------------------------------------------
#list the compute node management networkd card name (for example : eth0 em1)

#read COMPUTE_NET1_CARD_NAME

#nova.conf for compute node ,
#my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS

COMPUTE_MANAGEMENT_INTERFACE_IP_ADDRESS=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')
Management_ip=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')
Coppute_host=$(cat ./COMPUTE_HOSTS)

for ip in $Coppute_host
do 
if [[ $Management_ip = $ip ]];then
echo $MAGENTA Please choose a network card as External network from above output on ${YELLOW}$(hostname)${NO_COLOR}
#nova EXTERNAL NETWORK CARD  here
read COMPUTE_NET1_CARD_NAME
echo $GREEN You choose ${YELLOW}$COMPUTE_NET1_CARD_NAME${COLOR}${GREEN} as external network card $NO_COLOR
fi 
done 

#use for linuxbridge_agent.ini this need make sure 
PROVIDER_INTERFACE_NAME=${COMPUTE_NET1_CARD_NAME}
OVERLAY_INTERFACE_IP_ADDRESS=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')

#Edit the /etc/neutron/metadata_agent.ini 
METADATA_SECRET=secert_here

#Neutron for compute node 
COMPUTE_PROVIDER_INTERFACE_NAME=${COMPUTE_NET1_CARD_NAME}
COMPUTE_OVERLAY_INTERFACE_IP_ADDRESS=$(ifconfig $MGMT_IP_DEVICE | grep 'inet[^6]' | sed -n '1p' | awk '{print $2}')



